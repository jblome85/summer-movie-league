<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Summer Movie Draft 2025</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 20px auto;
      padding: 0 15px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-bottom: 30px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px 12px;
      text-align: left;
    }
    th {
      background: #f0f0f0;
    }
    #cumulative_chart {
      width: 100%;
      height: 500px;
    }
  </style>
</head>
<body>

  <h1>Summer Movie Draft 2025</h1>

  <section id="leaderboard">
    <h2>Leaderboard</h2>
    <div id="leaderboard_table">Loading leaderboard...</div>
  </section>

  <section id="cumulative">
    <h2>Cumulative Gross Over Time</h2>
    <div id="cumulative_chart">Loading chart...</div>
  </section>

<script>
  const summaryCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTnYWGxIRDHGb1vIHXDhuOnX3d8nULXEaFrOGmgUXWPdDfJCbp8v-Vb911xEJirIKTIj2U-N3Nwy0kS/pub?gid=1562983144&single=true&output=csv';
  const cumulativeCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTnYWGxIRDHGb1vIHXDhuOnX3d8nULXEaFrOGmgUXWPdDfJCbp8v-Vb911xEJirIKTIj2U-N3Nwy0kS/pub?gid=482616797&single=true&output=csv';

  // Simple CSV parser (no quoted fields handling)
  function parseCsv(text) {
    return text.trim().split('\n').map(line => line.split(','));
  }

  // Render an HTML table from 2D array data
  function renderTable(data) {
    if (!data || data.length === 0) return 'No data available.';
    let html = '<table><thead><tr>';
    data[0].forEach(header => html += `<th>${header}</th>`);
    html += '</tr></thead><tbody>';
    for(let i = 1; i < data.length; i++) {
      html += '<tr>';
      data[i].forEach(cell => html += `<td>${cell}</td>`);
      html += '</tr>';
    }
    html += '</tbody></table>';
    return html;
  }

  // Fetch CSV and parse it with debug logging
  async function fetchCsvWithLogging(url, label) {
    try {
      const response = await fetch(url);
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      const text = await response.text();
      console.log(`${label} CSV loaded successfully`);
      console.log(text.slice(0, 500) + '...'); // Log first 500 chars
      return parseCsv(text);
    } catch (err) {
      console.error(`Failed to load ${label} CSV:`, err);
      throw err;
    }
  }

  // Load and render leaderboard table (simple HTML table)
  async function loadLeaderboard() {
    const data = await fetchCsvWithLogging(summaryCsvUrl, 'Summary');
    document.getElementById('leaderboard_table').innerHTML = renderTable(data);
  }

  // Load cumulative CSV and draw Google Charts line chart
  async function drawCumulativeChart() {
    const dataArray = await fetchCsvWithLogging(cumulativeCsvUrl, 'Cumulative');

    google.charts.load('current', { packages: ['corechart'] });
    google.charts.setOnLoadCallback(() => {
      const dataTable = new google.visualization.DataTable();

      // First column is date (string)
      dataTable.addColumn('string', dataArray[0][0]);
      // Next columns are players (number)
      for (let i = 1; i < dataArray[0].length; i++) {
        dataTable.addColumn('number', dataArray[0][i]);
      }

      // Add rows, converting number strings to numbers
      for (let i = 1; i < dataArray.length; i++) {
        const row = [];
        row.push(dataArray[i][0]); // date string
        for (let j = 1; j < dataArray[i].length; j++) {
          // Remove $ and commas before converting
          const num = Number(dataArray[i][j].replace(/[$,]/g, ''));
          row.push(isNaN(num) ? 0 : num);
        }
        dataTable.addRow(row);
      }

      const options = {
        title: 'Cumulative Domestic Gross by Player',
        curveType: 'function',
        legend: { position: 'bottom' },
        height: 500,
        hAxis: { title: 'Date' },
        vAxis: { title: 'Gross ($)', format: 'currency' }
      };

      const chart = new google.visualization.LineChart(document.getElementById('cumulative_chart'));
      chart.draw(dataTable, options);
    });
  }

  // Initialize app
  async function init() {
    try {
      await loadLeaderboard();
      await drawCumulativeChart();
    } catch (err) {
      document.getElementById('leaderboard_table').textContent = 'Failed to load leaderboard data.';
      document.getElementById('cumulative_chart').textContent = 'Failed to load chart data.';
    }
  }

  init();

</script>

</body>
</html>
