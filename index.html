<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Summer Movie Draft 2025</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 20px auto;
      padding: 0 15px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-bottom: 30px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px 12px;
      text-align: left;
    }
    th {
      background: #f0f0f0;
    }
    #cumulative_chart {
      width: 100%;
      height: 500px;
    }
  </style>
</head>
<body>

  <h1>Summer Movie Draft 2025</h1>

  <section>
    <h2>Leaderboard</h2>
    <div id="leaderboard_table">Loading leaderboard...</div>
  </section>

  <section>
    <h2>Cumulative Gross Over Time</h2>
    <div id="cumulative_chart">Loading chart...</div>
  </section>

  <section>
    <h2>Top 10 Movies</h2>
    <div id="top_movies">Loading top movies...</div>
  </section>

<script>
  const summaryCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTnYWGxIRDHGb1vIHXDhuOnX3d8nULXEaFrOGmgUXWPdDfJCbp8v-Vb911xEJirIKTIj2U-N3Nwy0kS/pub?gid=1562983144&single=true&output=csv';
  const cumulativeCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTnYWGxIRDHGb1vIHXDhuOnX3d8nULXEaFrOGmgUXWPdDfJCbp8v-Vb911xEJirIKTIj2U-N3Nwy0kS/pub?gid=482616797&single=true&output=csv';
  const moviesCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTnYWGxIRDHGb1vIHXDhuOnX3d8nULXEaFrOGmgUXWPdDfJCbp8v-Vb911xEJirIKTIj2U-N3Nwy0kS/pub?gid=0&single=true&output=csv';

  // Render HTML table from 2D array, sorted by Rank (column index 4)
  function renderTable(data) {
    if (!data || !data.length) return 'No data to display.';

    const header = data[0];
    const rows = data.slice(1);

    // Sort rows ascending by Rank (index 4)
    rows.sort((a, b) => Number(a[4]) - Number(b[4]));

    let html = '<table><thead><tr>';
    header.forEach(h => { html += `<th>${h}</th>`; });
    html += '</tr></thead><tbody>';

    rows.forEach(row => {
      html += '<tr>';
      row.forEach((cell, index) => {
        if (index === 1 || index === 3) { // Format money columns as USD
          const num = Number(cell);
          const formatted = isNaN(num) ? cell : num.toLocaleString('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 });
          html += `<td>${formatted}</td>`;
        } else {
          html += `<td>${cell}</td>`;
        }
      });
      html += '</tr>';
    });

    html += '</tbody></table>';
    return html;
  }

  async function loadLeaderboard() {
    try {
      const res = await fetch(summaryCsvUrl);
      const text = await res.text();
      const parsed = Papa.parse(text, { skipEmptyLines: true });
      document.getElementById('leaderboard_table').innerHTML = renderTable(parsed.data);
    } catch (e) {
      document.getElementById('leaderboard_table').textContent = 'Failed to load leaderboard.';
      console.error('Error loading leaderboard:', e);
    }
  }

  function drawCumulativeChart(data) {
    const dataTable = new google.visualization.DataTable();

    dataTable.addColumn('string', data[0][0]); // Date
    for (let i = 1; i < data[0].length; i++) {
      dataTable.addColumn('number', data[0][i]);
    }

    for (let i = 1; i < data.length; i++) {
      const row = [data[i][0]];
      for (let j = 1; j < data[i].length; j++) {
        const val = Number(data[i][j].replace(/[$,]/g, ''));
        row.push(isNaN(val) ? 0 : val);
      }
      dataTable.addRow(row);
    }

    const options = {
      title: 'Cumulative Domestic Gross by Player',
      curveType: 'function',
      legend: { position: 'bottom' },
      height: 500,
      hAxis: { title: 'Date' },
      vAxis: { title: 'Gross ($)', format: 'currency' }
    };

    const chart = new google.visualization.LineChart(document.getElementById('cumulative_chart'));
    chart.draw(dataTable, options);
  }

  async function loadAndDrawCumulativeChart() {
    try {
      const res = await fetch(cumulativeCsvUrl);
      const text = await res.text();
      const parsed = Papa.parse(text, { skipEmptyLines: true });
      drawCumulativeChart(parsed.data);
    } catch (e) {
      document.getElementById('cumulative_chart').textContent = 'Failed to load chart.';
      console.error('Error loading cumulative chart:', e);
    }
  }

  async function loadTopMovies() {
  try {
    const res = await fetch(moviesCsvUrl);
    const text = await res.text();
    const parsed = Papa.parse(text, { skipEmptyLines: true });
    const data = parsed.data;

    const header = data[0];
    const rows = data.slice(1);

    // Find indices for Movie Name and Running Total columns (case-insensitive)
    const movieIndex = header.findIndex(h => /movie name/i.test(h));
    const grossIndex = header.findIndex(h => /running total/i.test(h));

    if (movieIndex === -1 || grossIndex === -1) {
      document.getElementById('top_movies').textContent = 'Movies CSV missing required columns.';
      console.log('Header row:', header);
      return;
    }

    // Sort descending by Running Total (convert to number)
    rows.sort((a, b) => {
      const grossA = Number((a[grossIndex] || '').replace(/[$,]/g, '')) || 0;
      const grossB = Number((b[grossIndex] || '').replace(/[$,]/g, '')) || 0;
      return grossB - grossA;
    });

    const top10 = rows.slice(0, 10);

    // Build table HTML
    let html = '<table><thead><tr><th>Rank</th><th>Movie</th><th>Running Total</th></tr></thead><tbody>';
    top10.forEach((row, i) => {
      const movie = row[movieIndex];
      const grossNum = Number((row[grossIndex] || '').replace(/[$,]/g, '')) || 0;
      const grossFormatted = grossNum.toLocaleString('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 });
      html += `<tr><td>${i + 1}</td><td>${movie}</td><td>${grossFormatted}</td></tr>`;
    });
    html += '</tbody></table>';

    document.getElementById('top_movies').innerHTML = html;

  } catch (e) {
    document.getElementById('top_movies').textContent = 'Failed to load top movies.';
    console.error('Error loading top movies:', e);
  }
}

  // Load all data and charts
  loadLeaderboard();
  google.charts.load('current', { packages: ['corechart'] });
  google.charts.setOnLoadCallback(loadAndDrawCumulativeChart);
  loadTopMovies();

</script>

</body>
</html>
