<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Summer Movie Draft 2025</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1000px;
      margin: 20px auto;
      padding: 0 15px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-bottom: 30px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px 12px;
      text-align: left;
    }
    th {
      background: #f0f0f0;
    }
    #cumulative_chart {
      width: 100%;
      height: 500px;
    }
    select {
      margin-bottom: 1em;
      padding: 6px 10px;
      font-size: 1em;
    }
  </style>
</head>
<body>

  <h1>Summer Movie Draft 2025</h1>

  <section>
    <label for="playerSelect"><strong>Select Your Player:</strong></label>
    <select id="playerSelect">
      <option value="">-- All Players --</option>
      <option value="Jon">Jon</option>
      <option value="Ryne">Ryne</option>
      <option value="Josh">Josh</option>
      <option value="Dan">Dan</option>
      <option value="Zac">Zac</option>
    </select>
  </section>

  <section>
    <h2>Leaderboard</h2>
    <div id="leaderboard_table">Loading leaderboard...</div>
  </section>

  <section>
    <h2>Cumulative Gross Over Time</h2>
    <div id="cumulative_chart">Loading chart...</div>
  </section>

  <section>
    <h2>Top 10 Movies</h2>
    <div id="top_movies">Loading top movies...</div>
  </section>

<script>
  const summaryCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTnYWGxIRDHGb1vIHXDhuOnX3d8nULXEaFrOGmgUXWPdDfJCbp8v-Vb911xEJirIKTIj2U-N3Nwy0kS/pub?gid=1562983144&single=true&output=csv';
  const cumulativeCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTnYWGxIRDHGb1vIHXDhuOnX3d8nULXEaFrOGmgUXWPdDfJCbp8v-Vb911xEJirIKTIj2U-N3Nwy0kS/pub?gid=482616797&single=true&output=csv';
  const moviesCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTnYWGxIRDHGb1vIHXDhuOnX3d8nULXEaFrOGmgUXWPdDfJCbp8v-Vb911xEJirIKTIj2U-N3Nwy0kS/pub?gid=0&single=true&output=csv';

  function renderTable(data) {
    if (!data || !data.length) return 'No data to display.';
    const selectedPlayer = document.getElementById('playerSelect')?.value || '';

    const header = data[0];
    const rows = data.slice(1);
    rows.sort((a, b) => Number(a[4]) - Number(b[4]));

    let html = '<table><thead><tr>';
    header.forEach(h => { html += `<th>${h}</th>`; });
    html += '</tr></thead><tbody>';

    rows.forEach(row => {
      const isHighlighted = row[0] === selectedPlayer;
      html += `<tr${isHighlighted ? ' style="background-color: #ffffcc;"' : ''}>`;
      row.forEach((cell, index) => {
        if (index === 1 || index === 3) {
          const num = Number(cell);
          const formatted = isNaN(num)
            ? cell
            : num.toLocaleString('en-US', {
                style: 'currency',
                currency: 'USD',
                maximumFractionDigits: 0,
              });
          html += `<td>${formatted}</td>`;
        } else {
          html += `<td>${cell}</td>`;
        }
      });
      html += '</tr>';
    });

    html += '</tbody></table>';
    return html;
  }

  async function loadLeaderboard() {
    try {
      const res = await fetch(summaryCsvUrl);
      const text = await res.text();
      const parsed = Papa.parse(text, { skipEmptyLines: true });
      document.getElementById('leaderboard_table').innerHTML = renderTable(parsed.data);
    } catch (e) {
      document.getElementById('leaderboard_table').textContent = 'Failed to load leaderboard.';
      console.error('Error loading leaderboard:', e);
    }
  }

  function drawCumulativeChart(data) {
    const selectedPlayer = document.getElementById('playerSelect')?.value || '';
    const dataTable = new google.visualization.DataTable();

    dataTable.addColumn('string', data[0][0]); // Date
    for (let i = 1; i < data[0].length; i++) {
      dataTable.addColumn('number', data[0][i]);
    }

    for (let i = 1; i < data.length; i++) {
      const row = [data[i][0]];
      for (let j = 1; j < data[i].length; j++) {
        const val = Number(data[i][j].replace(/[$,]/g, ''));
        row.push(isNaN(val) ? 0 : val);
      }
      dataTable.addRow(row);
    }

    const baseColors = ['#3366cc', '#dc3912', '#ff9900', '#109618', '#990099'];
    const series = {};

    for (let i = 0; i < baseColors.length; i++) {
      series[i] = { color: baseColors[i] };
    }

    if (selectedPlayer) {
      const colIndex = data[0].indexOf(selectedPlayer) - 1;
      if (colIndex >= 0) {
        for (let i = 0; i < baseColors.length; i++) {
          series[i] = { color: '#ccc', lineWidth: 1 };
        }
        series[colIndex] = { color: '#000', lineWidth: 4 };
      }
    }

    const options = {
      title: 'Cumulative Domestic Gross by Player',
      curveType: 'function',
      legend: { position: 'bottom' },
      height: 500,
      hAxis: { title: 'Date' },
      vAxis: { title: 'Gross ($)', format: 'currency' },
      series: series
    };

    const chart = new google.visualization.LineChart(document.getElementById('cumulative_chart'));
    chart.draw(dataTable, options);
  }

  async function loadAndDrawCumulativeChart() {
    try {
      const res = await fetch(cumulativeCsvUrl);
      const text = await res.text();
      const parsed = Papa.parse(text, { skipEmptyLines: true });
      drawCumulativeChart(parsed.data);
    } catch (e) {
      document.getElementById('cumulative_chart').textContent = 'Failed to load chart.';
      console.error('Error loading cumulative chart:', e);
    }
  }

  async function loadTopMovies() {
    try {
      const res = await fetch(moviesCsvUrl);
      const text = await res.text();
      const parsed = Papa.parse(text, { skipEmptyLines: true });
      const data = parsed.data;

      const header = data[0];
      const rows = data.slice(1);

      const movieIndex = header.findIndex(h => /movie name/i.test(h));
      const grossIndex = header.findIndex(h => /running total/i.test(h));

      if (movieIndex === -1 || grossIndex === -1) {
        document.getElementById('top_movies').textContent = 'Movies CSV missing required columns.';
        return;
      }

      rows.sort((a, b) => {
        const aVal = Number((a[grossIndex] || '').replace(/[$,]/g, '')) || 0;
        const bVal = Number((b[grossIndex] || '').replace(/[$,]/g, '')) || 0;
        return bVal - aVal;
      });

      const top10 = rows.slice(0, 10);

      let html = '<table><thead><tr><th>Rank</th><th>Movie</th><th>Gross</th></tr></thead><tbody>';
      top10.forEach((row, i) => {
        const title = row[movieIndex];
        const gross = Number(row[grossIndex].replace(/[$,]/g, '')) || 0;
        const formatted = gross.toLocaleString('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 });
        html += `<tr><td>${i + 1}</td><td>${title}</td><td>${formatted}</td></tr>`;
      });
      html += '</tbody></table>';

      document.getElementById('top_movies').innerHTML = html;

    } catch (e) {
      document.getElementById('top_movies').textContent = 'Failed to load top movies.';
      console.error('Error loading top movies:', e);
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('playerSelect').addEventListener('change', () => {
      loadLeaderboard();
      loadAndDrawCumulativeChart();
    });

    loadLeaderboard();
    loadTopMovies();

    google.charts.load('current', { packages: ['corechart'] });
    google.charts.setOnLoadCallback(loadAndDrawCumulativeChart);
  });
</script>

</body>
</html>
